version: 2.1

workflows:
  build_and_test_and_deploy:
    jobs:
      - build:
          context: 
            - org-global
            - keys
      # - test:
      #     context:
      #       - org-global
      #       - keys
      # - deploy: 
      #     context: 
      #       - org-global
      #       - keys

orbs:
  terraform: circleci/terraform@3.0.0
  aws-cli: circleci/aws-cli@2.0
  aws-ecr: circleci/aws-ecr@7.3.0
  aws-ecs: circleci/aws-ecs@2.2.1

jobs:

  aws-cli-example:
    executor: aws-cli/default
    steps:
      - checkout
      - aws-cli/setup:
          profile-name: example
      - run: echo "Run your code here"

  build:
    docker:
      - image: docker.mirror.hashicorp.services/hashicorp/terraform:light

    steps:
      - checkout
      - aws-cli/setup:
          aws-access-key-id: AWS_ACCESS_KEY_ID
          aws-secret-access-key: AWS_SECRET_ACCESS_KEY
          aws-region: AWS_REGION

      - aws-ecr/build-and-push-image:
          account-url: AWS_ECR_ACCOUNT_URL   
          repo: AWS_REPO
          tag: TAG
      
      - aws-ecs/run-task:
          awsvpc: false
          cluster: test2
          launch-type: FARGATE
          task-definition: testdef
  # test:
  #   docker:
  #     - image:
  #       auth:  

  # deploy:
  #   docker:
  #     - image: 
  #       auth: 


